# è¨­è¨ˆæ›¸: APIã‚­ãƒ¼ã®ã‚µãƒ¼ãƒãƒ¼å´ç§»è¡Œ

## Issueæƒ…å ±
- **Issueç•ªå·**: #8
- **ä½œæˆæ—¥**: 2026-02-14
- **è¨­è¨ˆè€…**: Claude Code
- **ãƒ¬ãƒ“ãƒ¥ãƒ¼**: [ä¿ç•™]

---

## 1. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1.1 ç¾çŠ¶ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆBeforeï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Flutter ã‚¢ãƒ—ãƒª (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ)        â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   VisionOcrService              â”‚   â”‚
â”‚  â”‚   - detectItemFromImage()       â”‚   â”‚
â”‚  â”‚   - _resizeImage()              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                           â”‚
â”‚             â”‚ HTTP POST (ç›´æ¥å‘¼ã³å‡ºã—)    â”‚
â”‚             â”‚ APIã‚­ãƒ¼: env.json ã‹ã‚‰å–å¾—  â”‚
â”‚             â†“                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                                      â”‚
              â†“                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google Cloud Vision API â”‚      â”‚     OpenAI API           â”‚
â”‚  - DOCUMENT_TEXT_DETECT  â”‚      â”‚     - gpt-4o-mini        â”‚
â”‚  - APIã‚­ãƒ¼: env.json     â”‚      â”‚     - APIã‚­ãƒ¼: env.json  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å•é¡Œç‚¹**:
- APIã‚­ãƒ¼ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼ˆ`env.json`ï¼‰ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹
- ã‚¢ãƒ—ãƒªãƒãƒ³ãƒ‰ãƒ«ã‚’è§£æã™ã‚Œã°APIã‚­ãƒ¼ãŒå–å¾—å¯èƒ½
- ä¸æ­£åˆ©ç”¨ã®ãƒªã‚¹ã‚¯ãŒé«˜ã„

---

### 1.2 æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆAfterï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Flutter ã‚¢ãƒ—ãƒª (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ)        â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   VisionOcrService              â”‚   â”‚
â”‚  â”‚   - detectItemFromImage()       â”‚   â”‚
â”‚  â”‚   - _resizeImage()              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                           â”‚
â”‚             â”‚ Firebase Functions Call   â”‚
â”‚             â”‚ (Firebase Auth Token)     â”‚
â”‚             â†“                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Firebase Cloud Functions (ã‚µãƒ¼ãƒãƒ¼å´)          â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   analyzeImage (Callable Function)         â”‚     â”‚
â”‚  â”‚   - èªè¨¼ãƒã‚§ãƒƒã‚¯ (context.auth)              â”‚     â”‚
â”‚  â”‚   - ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ (base64)            â”‚     â”‚
â”‚  â”‚   - Vision API å‘¼ã³å‡ºã—                     â”‚     â”‚
â”‚  â”‚   - OpenAI API å‘¼ã³å‡ºã—                     â”‚     â”‚
â”‚  â”‚   - çµæœã‚’è¿”å´                              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚             â”‚             â”‚                         â”‚
â”‚             â”‚ ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ APIã‚­ãƒ¼ã‚’å–å¾—              â”‚
â”‚             â”‚ GOOGLE_VISION_API_KEY                â”‚
â”‚             â”‚ OPENAI_API_KEY                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚             â”‚
              â†“             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google Cloud Vision API â”‚      â”‚     OpenAI API           â”‚
â”‚  - DOCUMENT_TEXT_DETECT  â”‚      â”‚     - gpt-4o-mini        â”‚
â”‚  - APIã‚­ãƒ¼: ç’°å¢ƒå¤‰æ•°      â”‚      â”‚     - APIã‚­ãƒ¼: ç’°å¢ƒå¤‰æ•°   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ”¹å–„ç‚¹**:
- APIã‚­ãƒ¼ã¯ã‚µãƒ¼ãƒãƒ¼å´ã®ç’°å¢ƒå¤‰æ•°ã§ã®ã¿ç®¡ç†
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯Firebase AuthenticationçµŒç”±ã§å‘¼ã³å‡ºã—
- èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- ãƒ­ã‚°ã¨ç›£æŸ»ãŒå®¹æ˜“

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 2.1 ç”»åƒè§£æãƒ•ãƒ­ãƒ¼ï¼ˆè©³ç´°ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®å‰å‡¦ç†
```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼] â†’ [ã‚«ãƒ¡ãƒ©æ’®å½±] â†’ [ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«(File)]
                                    â†“
                        [VisionOcrService.detectItemFromImage()]
                                    â†“
                        [_resizeImage()] â† æ—¢å­˜ã®æœ€é©åŒ–å‡¦ç†
                          - EXIFå›è»¢åæ˜ 
                          - ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ–
                          - ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆèª¿æ•´
                          - ãƒªã‚µã‚¤ã‚º (800px)
                          - JPEGåœ§ç¸® (85%)
                                    â†“
                        [Uint8List (æœ€é©åŒ–æ¸ˆã¿ç”»åƒ)]
                                    â†“
                        [Base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰]
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: Cloud Functions å‘¼ã³å‡ºã—
```
[Base64ç”»åƒãƒ‡ãƒ¼ã‚¿] â†’ [Firebase Functions]
                           â†“
              HttpsCallable('analyzeImage')
                           â†“
        {
          "imageUrl": "data:image/jpeg;base64,/9j/4AAQ...",
          "timestamp": "2026-02-14T10:30:00.000Z"
        }
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚µãƒ¼ãƒãƒ¼å´å‡¦ç†ï¼ˆCloud Functionsï¼‰
```
[analyzeImage é–¢æ•°]
     â†“
[èªè¨¼ãƒã‚§ãƒƒã‚¯]
  - context.auth ãŒå­˜åœ¨ã™ã‚‹ã‹
  - context.auth.uid ãŒæœ‰åŠ¹ã‹
     â†“
[ç”»åƒãƒ‡ãƒ¼ã‚¿ã®ãƒ‡ã‚³ãƒ¼ãƒ‰]
  - Base64 â†’ Buffer
     â†“
[Vision API å‘¼ã³å‡ºã—]
  - visionClient.documentTextDetection()
  - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 10ç§’
     â†“
[OCRãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º]
  - fullTextAnnotation.text
     â†“
[OpenAI API å‘¼ã³å‡ºã—]
  - model: gpt-4o-mini
  - system prompt: å•†å“æƒ…å ±æŠ½å‡º
  - user prompt: OCRãƒ†ã‚­ã‚¹ãƒˆ
  - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 15ç§’
     â†“
[JSONè§£æ]
  - { "name": "å•†å“å", "price": 138 }
     â†“
[ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´]
  - { success: true, name: "...", price: 138 }
```

#### ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®çµæœå‡¦ç†
```
[Cloud Functions ãƒ¬ã‚¹ãƒãƒ³ã‚¹]
     â†“
[OcrItemResult ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ]
     â†“
[UI ã«åæ˜ ]
  - å•†å“åã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
  - ä¾¡æ ¼ã‚’è¡¨ç¤º
```

---

## 3. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 3.1 Cloud Functions: analyzeImage

#### ã‚·ã‚°ãƒãƒãƒ£
```javascript
exports.analyzeImage = functions.https.onCall(async (data, context) => {
  // ...
});
```

#### å…¥åŠ›
```typescript
interface AnalyzeImageRequest {
  imageUrl: string;      // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿
  timestamp?: string;    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚åˆ»ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
}
```

#### å‡ºåŠ›ï¼ˆæˆåŠŸæ™‚ï¼‰
```typescript
interface AnalyzeImageResponse {
  success: true;
  name: string;          // å•†å“å
  price: number;         // ç¨è¾¼ä¾¡æ ¼
  ocrText: string;       // æŠ½å‡ºã•ã‚ŒãŸOCRãƒ†ã‚­ã‚¹ãƒˆ
  timestamp: string;     // å‡¦ç†æ™‚åˆ»
  userId: string;        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
}
```

#### å‡ºåŠ›ï¼ˆå¤±æ•—æ™‚ï¼‰
```typescript
interface AnalyzeImageErrorResponse {
  success: false;
  error: string;         // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  timestamp: string;     // å‡¦ç†æ™‚åˆ»
  ocrText?: string;      // OCRãƒ†ã‚­ã‚¹ãƒˆï¼ˆæŠ½å‡ºã§ããŸå ´åˆï¼‰
}
```

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
| ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
|-------------|---------------|----------------|
| ç”»åƒãƒ‡ãƒ¼ã‚¿ãªã— | `invalid-argument` | "ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™" |
| èªè¨¼ã‚¨ãƒ©ãƒ¼ | `unauthenticated` | "èªè¨¼ãŒå¿…è¦ã§ã™" |
| ãƒ†ã‚­ã‚¹ãƒˆæ¤œå‡ºå¤±æ•— | 200 (success: false) | "ãƒ†ã‚­ã‚¹ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" |
| Vision APIã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | `deadline-exceeded` | "è§£æãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ç”»åƒã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚" |
| OpenAI APIã‚¨ãƒ©ãƒ¼ | `internal` | "ç”»åƒè§£æã«å¤±æ•—ã—ã¾ã—ãŸ: [è©³ç´°]" |

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
1. **èªè¨¼ãƒã‚§ãƒƒã‚¯**:
   ```javascript
   if (!context.auth) {
     throw new functions.https.HttpsError('unauthenticated', 'èªè¨¼ãŒå¿…è¦ã§ã™');
   }
   ```

2. **ãƒ­ã‚°è¨˜éŒ²**:
   ```javascript
   console.log('ğŸ–¼ï¸ ç”»åƒè§£æé–‹å§‹:', {
     userId: context.auth.uid,
     timestamp: new Date().toISOString()
   });
   ```

3. **ç’°å¢ƒå¤‰æ•°ã®ä¿è­·**:
   - APIã‚­ãƒ¼ã¯ `process.env.GOOGLE_VISION_API_KEY` ã‹ã‚‰å–å¾—
   - ãƒ­ã‚°ã«APIã‚­ãƒ¼ã‚’å‡ºåŠ›ã—ãªã„

---

### 3.2 Flutter Client: VisionOcrService

#### ä¿®æ­£å‰ã®ã‚³ãƒ¼ãƒ‰æ§‹é€ 
```dart
class VisionOcrService {
  final String apiKey;  // env.json ã‹ã‚‰å–å¾—

  Future<OcrItemResult?> detectItemFromImage(File image, ...) async {
    // 1. ç”»åƒã‚’å‰å‡¦ç†
    final resizedBytes = await _resizeImage(image);
    final b64 = base64Encode(resizedBytes);

    // 2. Vision API ã«ç›´æ¥å‘¼ã³å‡ºã— â† å•é¡Œç®‡æ‰€
    final url = Uri.parse(
      'https://vision.googleapis.com/v1/images:annotate?key=$apiKey',
    );
    final resp = await http.post(url, ...);

    // 3. OpenAI API ã«ç›´æ¥å‘¼ã³å‡ºã— â† å•é¡Œç®‡æ‰€
    final chat = ChatGptService();
    final result = await chat.extractProductInfo(fullText);
  }
}
```

#### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰æ§‹é€ 
```dart
class VisionOcrService {
  // apiKey ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å‰Šé™¤

  Future<OcrItemResult?> detectItemFromImage(File image, ...) async {
    // 1. ç”»åƒã‚’å‰å‡¦ç†ï¼ˆå¤‰æ›´ãªã—ï¼‰
    final resizedBytes = await _resizeImage(image);
    final b64 = base64Encode(resizedBytes);

    // 2. Cloud Functions ã‚’å‘¼ã³å‡ºã—ï¼ˆæ–°è¦ï¼‰
    final callable = FirebaseFunctions.instance.httpsCallable('analyzeImage');
    final response = await callable.call({
      'imageUrl': b64,
      'timestamp': DateTime.now().toIso8601String(),
    }).timeout(const Duration(seconds: 30));

    // 3. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
    final data = response.data;
    if (data['success'] == true) {
      return OcrItemResult(
        name: data['name'],
        price: data['price'],
      );
    } else {
      // ã‚¨ãƒ©ãƒ¼å‡¦ç†
      onProgress?.call(OcrProgressStep.failed, data['error']);
      return null;
    }
  }
}
```

#### ä¾å­˜é–¢ä¿‚ã®è¿½åŠ 
`pubspec.yaml`:
```yaml
dependencies:
  cloud_functions: ^5.1.4  # æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
```

---

### 3.3 ç’°å¢ƒå¤‰æ•°ç®¡ç†

#### Firebase Console ã§ã®è¨­å®š
```bash
# Firebase CLIã§è¨­å®šã™ã‚‹å ´åˆ
firebase functions:config:set \
  api.google_vision_key="AIza..." \
  api.openai_key="sk-..."

# ç¢ºèª
firebase functions:config:get
```

å‡ºåŠ›ä¾‹:
```json
{
  "api": {
    "google_vision_key": "AIza...",
    "openai_key": "sk-..."
  }
}
```

#### Cloud Functions ã§ã®å–å¾—
```javascript
// æ—§æ–¹å¼ï¼ˆfunctions:configï¼‰
const visionApiKey = functions.config().api.google_vision_key;
const openaiApiKey = functions.config().api.openai_key;

// ã¾ãŸã¯ã€ç’°å¢ƒå¤‰æ•°æ–¹å¼ï¼ˆæ¨å¥¨ï¼‰
const visionApiKey = process.env.GOOGLE_VISION_API_KEY;
const openaiApiKey = process.env.OPENAI_API_KEY;
```

#### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼ˆfunctions/.envï¼‰
```env
GOOGLE_VISION_API_KEY=AIza...
OPENAI_API_KEY=sk-...
```

`.env` ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `.gitignore` ã«å«ã‚ã‚‹:
```gitignore
# functions/.gitignore
.env
*.env
```

---

## 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ

### 4.1 ã‚¨ãƒ©ãƒ¼åˆ†é¡

| ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ— | ç™ºç”Ÿç®‡æ‰€ | å¯¾å‡¦æ–¹æ³• |
|-------------|---------|---------|
| **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼** | Cloud Functionså‘¼ã³å‡ºã— | ãƒªãƒˆãƒ©ã‚¤ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¡¨ç¤º |
| **èªè¨¼ã‚¨ãƒ©ãƒ¼** | Cloud Functions | ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«èª˜å° |
| **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ** | Vision API / OpenAI API | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ç”»åƒã‚µã‚¤ã‚ºç¸®å°ã‚’ææ¡ˆ |
| **OCRå¤±æ•—** | Vision API | "ãƒ†ã‚­ã‚¹ãƒˆãŒèªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ" |
| **å•†å“æƒ…å ±æŠ½å‡ºå¤±æ•—** | OpenAI API | "å•†å“æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" |
| **Cloud Functionså†…éƒ¨ã‚¨ãƒ©ãƒ¼** | ã‚µãƒ¼ãƒãƒ¼å´ | "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" |

### 4.2 ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´
- **è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤**: ãªã—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ˜ç¤ºçš„ãªå†è©¦è¡Œã®ã¿ï¼‰
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 30ç§’

#### ã‚µãƒ¼ãƒãƒ¼å´ï¼ˆCloud Functionsï¼‰
- **Vision API ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 10ç§’
- **OpenAI API ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 15ç§’
- **ãƒªãƒˆãƒ©ã‚¤**: `Promise.race()` ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ã€è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ãªã—

### 4.3 ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­è¨ˆ

| ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | æŠ€è¡“çš„ãªåŸå›  | ãƒ­ã‚°å‡ºåŠ› |
|---------------------|------------|---------|
| "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„" | Cloud Functionså‘¼ã³å‡ºã—å¤±æ•— | `âŒ Cloud Functionså‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: [è©³ç´°]` |
| "ãƒ†ã‚­ã‚¹ãƒˆãŒèªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ" | Vision API ãŒãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œå‡ºã§ããš | `âš ï¸ ãƒ†ã‚­ã‚¹ãƒˆæ¤œå‡ºå¤±æ•—` |
| "å•†å“æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" | OpenAI API ãŒå•†å“æƒ…å ±ã‚’æŠ½å‡ºã§ããš | `âš ï¸ å•†å“æƒ…å ±æŠ½å‡ºå¤±æ•—` |
| "è§£æãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ" | Vision/OpenAI APIã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | `â° ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: Vision/OpenAI API` |
| "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" | Cloud Functionså†…éƒ¨ã‚¨ãƒ©ãƒ¼ | `âŒ Cloud Functionså†…éƒ¨ã‚¨ãƒ©ãƒ¼: [è©³ç´°]` |

---

## 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 5.1 èªè¨¼ãƒ»èªå¯

#### Firebase Authentication
- **å¿…é ˆ**: å…¨ã¦ã®Cloud Functionså‘¼ã³å‡ºã—ã«èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦
- **ãƒã‚§ãƒƒã‚¯**: `context.auth` ã®å­˜åœ¨ç¢ºèª
- **åŒ¿åèªè¨¼**: ã‚µãƒãƒ¼ãƒˆï¼ˆ`context.auth.uid` ãŒå­˜åœ¨ã™ã‚Œã°OKï¼‰

#### å®Ÿè£…ä¾‹ï¼ˆCloud Functionsï¼‰
```javascript
exports.analyzeImage = functions.https.onCall(async (data, context) => {
  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', 'èªè¨¼ãŒå¿…è¦ã§ã™');
  }

  const userId = context.auth.uid;
  console.log('ğŸ“¸ ç”»åƒè§£æãƒªã‚¯ã‚¨ã‚¹ãƒˆ:', { userId });

  // ... å‡¦ç† ...
});
```

### 5.2 APIã‚­ãƒ¼ç®¡ç†

#### ä¿å­˜å ´æ‰€
| ç’°å¢ƒ | APIã‚­ãƒ¼ã®ä¿å­˜å ´æ‰€ | ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³• |
|------|----------------|------------|
| **æœ¬ç•ªç’°å¢ƒ** | Firebase Functions ç’°å¢ƒå¤‰æ•° | `process.env.GOOGLE_VISION_API_KEY` |
| **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º** | `functions/.env` | åŒä¸Šï¼ˆdotenvè‡ªå‹•èª­ã¿è¾¼ã¿ï¼‰ |
| **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ** | **å‰Šé™¤** | N/A |

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–
1. **ç’°å¢ƒå¤‰æ•°ã®æš—å·åŒ–**: Firebase Consoleã§è‡ªå‹•çš„ã«æš—å·åŒ–
2. **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**: Cloud Functionså†…éƒ¨ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
3. **ãƒ­ã‚°ä¿è­·**: APIã‚­ãƒ¼ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ãªã„
4. **å®šæœŸçš„ãªãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**: 3ãƒ¶æœˆã”ã¨ã«APIã‚­ãƒ¼ã‚’æ›´æ–°ï¼ˆæ¨å¥¨ï¼‰

### 5.3 ãƒ¬ãƒ¼ãƒˆåˆ¶é™

#### Cloud Functions
- **åŒæ™‚å®Ÿè¡Œæ•°**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 1000ï¼ˆFirebase Console ã§èª¿æ•´å¯èƒ½ï¼‰
- **å‰²å½“é‡**: å‘¼ã³å‡ºã—å›æ•°ã®ä¸Šé™ã‚’è¨­å®šï¼ˆä¾‹: 10,000å›/æ—¥ï¼‰

#### Vision API
- **å‰²å½“é‡**: Google Cloud Console ã§è¨­å®š
- **æ¨å¥¨**: 1,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥ï¼ˆç„¡æ–™æ å†…ï¼‰

#### OpenAI API
- **å‰²å½“é‡**: OpenAI Dashboard ã§è¨­å®š
- **æ¨å¥¨**: ä½¿ç”¨é‡ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¨­å®š

---

## 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­è¨ˆ

### 6.1 å‡¦ç†æ™‚é–“ã®è¦‹ç©ã‚‚ã‚Š

| å‡¦ç† | æ‰€è¦æ™‚é–“ | å‚™è€ƒ |
|-----|---------|-----|
| ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ç”»åƒå‰å‡¦ç† | 1-2ç§’ | ãƒªã‚µã‚¤ã‚ºã€ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ç­‰ |
| Cloud Functions å‘¼ã³å‡ºã— | 0.5ç§’ | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ |
| Vision API (OCR) | 3-5ç§’ | ç”»åƒã‚µã‚¤ã‚ºã«ä¾å­˜ |
| OpenAI API (è§£æ) | 2-4ç§’ | ãƒ¢ãƒ‡ãƒ«: gpt-4o-mini |
| **åˆè¨ˆ** | **7-12ç§’** | ç¾çŠ¶ã¨åŒç­‰ã¾ãŸã¯ãã‚Œä»¥ä¸‹ |

### 6.2 æœ€é©åŒ–æˆ¦ç•¥

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´
1. **ç”»åƒã‚µã‚¤ã‚ºã®æœ€é©åŒ–**:
   - æœ€å¤§ã‚µã‚¤ã‚º: 800pxï¼ˆæ—¢å­˜å®Ÿè£…ã‚’ç¶­æŒï¼‰
   - JPEGå“è³ª: 85%
   - ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ–ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›

2. **ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º**:
   - `OcrProgressCallback` ã§é€²æ—ã‚’è¡¨ç¤º
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æ”¹å–„

#### ã‚µãƒ¼ãƒãƒ¼å´
1. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®æœ€é©åŒ–**:
   - Vision API: 10ç§’
   - OpenAI API: 15ç§’
   - åˆè¨ˆ: 30ç§’ä»¥å†…

2. **ä¸¦åˆ—å‡¦ç†**:
   - ç¾åœ¨ã¯ç›´åˆ—å‡¦ç†ï¼ˆVision â†’ OpenAIï¼‰
   - å°†æ¥çš„ãªæ”¹å–„æ¡ˆ: Vision APIã¨OpenAI APIã‚’ä¸¦åˆ—å®Ÿè¡Œï¼ˆãŸã ã—ç¾åœ¨ã¯ç›´åˆ—ãŒå¿…é ˆï¼‰

---

## 7. ãƒ†ã‚¹ãƒˆè¨­è¨ˆ

### 7.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

#### VisionOcrService ã®ãƒ†ã‚¹ãƒˆ
```dart
// test/services/vision_ocr_service_test.dart

void main() {
  group('VisionOcrService', () {
    test('Cloud Functionså‘¼ã³å‡ºã—ãŒæˆåŠŸã™ã‚‹', () async {
      // ãƒ¢ãƒƒã‚¯Cloud Functionsã‚’è¨­å®š
      final mockCallable = MockHttpsCallable();
      when(mockCallable.call(any)).thenAnswer((_) async => MockHttpsCallableResult({
        'success': true,
        'name': 'ãƒ†ã‚¹ãƒˆå•†å“',
        'price': 100,
      }));

      final service = VisionOcrService();
      final result = await service.detectItemFromImage(testImage);

      expect(result, isNotNull);
      expect(result!.name, 'ãƒ†ã‚¹ãƒˆå•†å“');
      expect(result.price, 100);
    });

    test('ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹', () async {
      // ...
    });
  });
}
```

### 7.2 çµ±åˆãƒ†ã‚¹ãƒˆ

#### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª
1. **æ­£å¸¸ç³»**:
   - å•†å“ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
   - å•†å“åã¨ä¾¡æ ¼ãŒæ­£ã—ãæŠ½å‡ºã•ã‚Œã‚‹

2. **ç•°å¸¸ç³»**:
   - ãƒ†ã‚­ã‚¹ãƒˆã®ãªã„ç”»åƒï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼‰
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ï¼ˆãƒªãƒˆãƒ©ã‚¤ææ¡ˆï¼‰
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç”»åƒã‚µã‚¤ã‚ºç¸®å°ææ¡ˆï¼‰

### 7.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ

#### ãƒã‚§ãƒƒã‚¯é …ç›®
- [ ] ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã‚³ãƒ¼ãƒ‰ã«APIã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ãªã„
- [ ] ãƒ“ãƒ«ãƒ‰æˆæœç‰©ï¼ˆAPK/IPAï¼‰ã«APIã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ãªã„
- [ ] æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCloud Functionsã‚’å‘¼ã³å‡ºã›ãªã„
- [ ] ãƒ­ã‚°ã«APIã‚­ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ãªã„

---

## 8. ç›£è¦–ãƒ»ãƒ­ã‚°è¨­è¨ˆ

### 8.1 ãƒ­ã‚°å‡ºåŠ›

#### Cloud Functions
```javascript
// æˆåŠŸãƒ­ã‚°
console.log('âœ… è§£æå®Œäº†:', { name: result.name, price: result.price, userId });

// ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
console.error('âŒ ç”»åƒè§£æã‚¨ãƒ©ãƒ¼:', error);

// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
console.log('ğŸ“¸ Vision APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', { textLength: ocrText.length });
```

#### Flutter ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
```dart
// æˆåŠŸãƒ­ã‚°
debugPrint('âœ… Cloud Functionså‘¼ã³å‡ºã—æˆåŠŸ: name=${result.name}');

// ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
debugPrint('âŒ Cloud Functionsã‚¨ãƒ©ãƒ¼: $error');
```

### 8.2 ç›£è¦–ãƒ¡ãƒˆãƒªã‚¯ã‚¹

#### Firebase Console
1. **å‘¼ã³å‡ºã—å›æ•°**: æ—¥æ¬¡ãƒ»æ™‚é–“åˆ¥ã®æ¨ç§»
2. **ã‚¨ãƒ©ãƒ¼ç‡**: ç•°å¸¸å€¤ã®æ¤œå‡º
3. **å®Ÿè¡Œæ™‚é–“**: p50, p95, p99ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«
4. **èª²é‡‘é¡**: Vision API / OpenAI API ã®ä½¿ç”¨é‡

#### ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
- ã‚¨ãƒ©ãƒ¼ç‡ > 5%
- å‘¼ã³å‡ºã—å›æ•° > 10,000å›/æ—¥
- å®Ÿè¡Œæ™‚é–“ > 30ç§’

---

## 9. ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥

### 9.1 ãƒ‡ãƒ—ãƒ­ã‚¤é †åº
1. **Cloud Functions ã®ãƒ‡ãƒ—ãƒ­ã‚¤**:
   ```bash
   cd functions
   firebase deploy --only functions:analyzeImage
   ```

2. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã®ãƒ“ãƒ«ãƒ‰**:
   ```bash
   flutter build appbundle --release  # Android
   flutter build ios --release         # iOS
   ```

3. **æ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ**:
   - 10% â†’ å•é¡Œãªã‘ã‚Œã° â†’ 50% â†’ 100%

### 9.2 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»
1. **Cloud Functions ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**:
   ```bash
   firebase functions:rollback analyzeImage --version <previous-version>
   ```

2. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**:
   - Google Play Console / App Store Connect ã§ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™

---

## 10. ä»Šå¾Œã®æ‹¡å¼µæ€§

### 10.1 å°†æ¥çš„ãªæ”¹å–„æ¡ˆ
1. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿæ§‹**:
   - åŒã˜ç”»åƒã®å†è§£æã‚’é˜²ã
   - Firestore ã«OCRçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥

2. **ãƒãƒƒãƒå‡¦ç†**:
   - è¤‡æ•°ç”»åƒã®ä¸€æ‹¬è§£æ
   - Cloud Tasksã§éåŒæœŸå‡¦ç†

3. **ãƒ¢ãƒ‡ãƒ«ã®æœ€é©åŒ–**:
   - OpenAI APIã®ä»£ã‚ã‚Šã«Vertex AIã‚’æ¤œè¨
   - ã‚³ã‚¹ãƒˆå‰Šæ¸›ã¨é«˜é€ŸåŒ–

4. **ã‚¨ãƒƒã‚¸å‡¦ç†**:
   - ML Kitï¼ˆã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹ï¼‰ã§ã®OCR
   - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ

---

## 11. å‚è€ƒè³‡æ–™

### å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [Firebase Cloud Functions](https://firebase.google.com/docs/functions)
- [Firebase Callable Functions](https://firebase.google.com/docs/functions/callable)
- [Google Cloud Vision API](https://cloud.google.com/vision/docs)
- [OpenAI API](https://platform.openai.com/docs/api-reference)

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- [Firebase Security Best Practices](https://firebase.google.com/docs/rules/security-rules-and-auth)
- [OWASP Mobile Security](https://owasp.org/www-project-mobile-security/)

---

## 12. æ‰¿èª

| å½¹å‰² | æ°å | æ—¥ä»˜ | ç½²å |
|------|------|------|------|
| è¨­è¨ˆè€… | Claude Code | 2026-02-14 | - |
| ãƒ¬ãƒ“ãƒ¥ãƒ¼ | - | - | - |
| æ‰¿èª | - | - | - |
