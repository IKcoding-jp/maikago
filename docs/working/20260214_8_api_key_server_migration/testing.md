# テスト計画書: APIキーのサーバー側移行

## Issue情報
- **Issue番号**: #8
- **作成日**: 2026-02-14
- **テスト責任者**: [未割当]
- **テスト期間**: [未設定]

---

## 1. テスト概要

### 1.1 テストの目的
1. **セキュリティの検証**: APIキーがクライアント側から完全に削除されていることを確認
2. **機能の検証**: OCR機能（画像から商品情報抽出）が正常に動作することを確認
3. **パフォーマンスの検証**: 処理時間が許容範囲内であることを確認
4. **エラーハンドリングの検証**: 各種エラーケースで適切に動作することを確認

### 1.2 テスト対象
- **Cloud Functions**: `analyzeImage` 関数
- **Flutter アプリ**: `VisionOcrService`、`ChatGptService`
- **環境変数管理**: `env.dart`, `config.dart`, `env.json`

### 1.3 テスト環境
| 環境 | 説明 | 用途 |
|------|------|------|
| **ローカル開発** | Functions Emulator + デバッグビルド | 開発・デバッグ |
| **ステージング** | Firebase Test Project + デバッグビルド | 統合テスト |
| **本番環境** | Firebase Production Project + リリースビルド | 受け入れテスト |

---

## 2. テストケース

### 2.1 セキュリティテスト

#### TC-SEC-001: クライアント側のコードにAPIキーが存在しないこと
**優先度**: 最高
**テスト方法**: 静的解析

**手順**:
1. `lib/env.dart` を開く
2. `googleVisionApiKey` と `openAIApiKey` のgetterが削除されていることを確認
3. `lib/config.dart` を開く
4. APIキー関連のgetterが削除されていることを確認
5. `grep -r "AIza" lib/` でVision APIキーの文字列を検索
6. `grep -r "sk-" lib/` でOpenAI APIキーの文字列を検索

**期待結果**:
- [ ] `lib/env.dart` にAPIキー関連のgetterが存在しない
- [ ] `lib/config.dart` にAPIキー関連のgetterが存在しない
- [ ] `lib/` ディレクトリ内にAPIキーの文字列が存在しない

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-SEC-002: env.jsonにAPIキーが存在しないこと
**優先度**: 最高
**テスト方法**: ファイル検査

**手順**:
1. `env.json` を開く
2. `GOOGLE_VISION_API_KEY` キーが存在しないことを確認
3. `OPENAI_API_KEY` キーが存在しないことを確認

**期待結果**:
- [ ] `env.json` に `GOOGLE_VISION_API_KEY` が存在しない
- [ ] `env.json` に `OPENAI_API_KEY` が存在しない
- [ ] 他のキー（AdMob等）は正常に残っている

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-SEC-003: ビルド成果物にAPIキーが含まれていないこと
**優先度**: 最高
**テスト方法**: バイナリ解析

**手順**:
1. リリースビルドを作成:
   ```bash
   flutter build apk --release
   ```
2. APKファイルを解析:
   ```bash
   strings build/app/outputs/flutter-apk/app-release.apk > apk_strings.txt
   grep "AIza" apk_strings.txt  # Vision APIキー
   grep "sk-" apk_strings.txt   # OpenAI APIキー
   ```
3. 結果を確認

**期待結果**:
- [ ] APK内にVision APIキーが含まれていない
- [ ] APK内にOpenAI APIキーが含まれていない

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-SEC-004: Cloud Functionsの認証チェックが機能すること
**優先度**: 高
**テスト方法**: 手動テスト

**手順**:
1. Firebase Authenticationからログアウト
2. OCR機能を実行
3. エラーメッセージを確認

**期待結果**:
- [ ] "認証が必要です" または同等のエラーメッセージが表示される
- [ ] Cloud Functionsが `unauthenticated` エラーを返す

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-SEC-005: Cloud FunctionsのログにユーザーIDが記録されること
**優先度**: 中
**テスト方法**: ログ確認

**手順**:
1. 認証済みユーザーでOCR機能を実行
2. Firebase Console → Functions → Logs に移動
3. 最新のログを確認

**期待結果**:
- [ ] ログに `userId: <ユーザーID>` が記録されている
- [ ] ログにAPIキーが出力されていない

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

### 2.2 機能テスト

#### TC-FUNC-001: 正常な商品画像からの情報抽出（基本ケース）
**優先度**: 最高
**テスト方法**: 手動テスト

**手順**:
1. アプリを起動
2. 商品画像（例: お菓子の値札）を撮影またはギャラリーから選択
3. OCR機能を実行
4. 結果を確認

**テストデータ**:
- 商品名: "やわらかパイ"
- 税込価格: 138円

**期待結果**:
- [ ] 商品名が正しく抽出される（"やわらかパイ" または類似）
- [ ] 税込価格が正しく抽出される（138）
- [ ] 処理時間が30秒以内
- [ ] 進捗表示が適切に更新される

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-FUNC-002: 複数の価格が含まれる画像
**優先度**: 高
**テスト方法**: 手動テスト

**手順**:
1. 税抜価格と税込価格の両方が表示された商品画像を用意
2. OCR機能を実行
3. 結果を確認

**テストデータ**:
- 税抜価格: 128円
- 税込価格: 138円

**期待結果**:
- [ ] 税込価格（138円）が抽出される
- [ ] 税抜価格ではない

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-FUNC-003: 画像にテキストが含まれない場合
**優先度**: 高
**テスト方法**: 手動テスト

**手順**:
1. 無地の画像（白紙など）を用意
2. OCR機能を実行
3. エラーメッセージを確認

**期待結果**:
- [ ] "テキストが検出されませんでした" または同等のエラーメッセージが表示される
- [ ] アプリがクラッシュしない

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-FUNC-004: 商品情報が抽出できない画像
**優先度**: 高
**テスト方法**: 手動テスト

**手順**:
1. 文字はあるが商品情報ではない画像（例: 新聞記事）を用意
2. OCR機能を実行
3. エラーメッセージを確認

**期待結果**:
- [ ] "商品情報が見つかりませんでした" または同等のエラーメッセージが表示される
- [ ] アプリがクラッシュしない

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-FUNC-005: 大きな画像のアップロード
**優先度**: 中
**テスト方法**: 手動テスト

**手順**:
1. 高解像度の画像（例: 4000x3000px）を用意
2. OCR機能を実行
3. 処理時間とリサイズ処理を確認

**期待結果**:
- [ ] 画像が800pxにリサイズされる（ログで確認）
- [ ] 処理時間が30秒以内
- [ ] 正しく商品情報が抽出される

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-FUNC-006: 回転した画像の処理
**優先度**: 中
**テスト方法**: 手動テスト

**手順**:
1. 横向きの商品画像を用意
2. OCR機能を実行
3. 結果を確認

**期待結果**:
- [ ] EXIF情報に基づいて画像が正しく回転される
- [ ] 商品情報が正しく抽出される

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

### 2.3 パフォーマンステスト

#### TC-PERF-001: 標準的な画像の処理時間
**優先度**: 高
**テスト方法**: 自動テスト + 手動測定

**手順**:
1. 標準的な商品画像（800x600px程度）を用意
2. OCR機能を実行
3. 処理時間を測定（開始から結果表示まで）
4. 10回繰り返して平均値を算出

**期待結果**:
- [ ] 平均処理時間が15秒以内
- [ ] 90%のケースで20秒以内
- [ ] 100%のケースで30秒以内

**実際の結果**:
- 平均: ___秒
- 90%: ___秒
- 最大: ___秒
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-PERF-002: Cloud Functions のコールドスタート時間
**優先度**: 中
**テスト方法**: 手動測定

**手順**:
1. Cloud Functions が10分以上呼び出されていない状態にする
2. OCR機能を実行
3. 処理時間を測定

**期待結果**:
- [ ] コールドスタート時でも30秒以内に完了

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-PERF-003: 連続実行時の安定性
**優先度**: 中
**テスト方法**: 負荷テスト

**手順**:
1. OCR機能を10回連続で実行
2. 各回の処理時間を記録
3. エラー発生回数を記録

**期待結果**:
- [ ] 全ての実行が成功（エラー率 0%）
- [ ] 処理時間に大きな変動がない（標準偏差 < 5秒）

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

### 2.4 エラーハンドリングテスト

#### TC-ERR-001: ネットワークエラー（オフライン状態）
**優先度**: 高
**テスト方法**: 手動テスト

**手順**:
1. デバイスを機内モードに設定
2. OCR機能を実行
3. エラーメッセージを確認

**期待結果**:
- [ ] "ネットワーク接続を確認してください" または同等のエラーメッセージが表示される
- [ ] アプリがクラッシュしない

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-ERR-002: タイムアウト（30秒超過）
**優先度**: 高
**テスト方法**: 手動テスト（モック）

**手順**:
1. Cloud Functions を一時的に遅延させる（または、ネットワーク速度を制限）
2. OCR機能を実行
3. 30秒後の動作を確認

**期待結果**:
- [ ] 30秒でタイムアウトエラーが表示される
- [ ] "解析がタイムアウトしました" または同等のメッセージが表示される
- [ ] アプリがクラッシュしない

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-ERR-003: Vision API エラー
**優先度**: 中
**テスト方法**: 手動テスト（モック）

**手順**:
1. Cloud Functions の Vision API キーを一時的に無効化
2. OCR機能を実行
3. エラーメッセージを確認

**期待結果**:
- [ ] "画像解析に失敗しました" または同等のエラーメッセージが表示される
- [ ] Cloud Functions のログにエラー詳細が記録される

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-ERR-004: OpenAI API エラー
**優先度**: 中
**テスト方法**: 手動テスト（モック）

**手順**:
1. Cloud Functions の OpenAI API キーを一時的に無効化
2. OCR機能を実行
3. エラーメッセージを確認

**期待結果**:
- [ ] "画像解析に失敗しました" または同等のエラーメッセージが表示される
- [ ] Cloud Functions のログにエラー詳細が記録される

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-ERR-005: 不正な画像データ
**優先度**: 中
**テスト方法**: 自動テスト

**手順**:
1. 破損した画像ファイルを用意
2. OCR機能を実行
3. エラーメッセージを確認

**期待結果**:
- [ ] 適切なエラーメッセージが表示される
- [ ] アプリがクラッシュしない

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

### 2.5 互換性テスト

#### TC-COMP-001: Android デバイスでの動作
**優先度**: 最高
**テスト方法**: 実機テスト

**手順**:
1. 複数のAndroidデバイス（異なるOSバージョン）でテスト
2. OCR機能を実行
3. 結果を確認

**テストデバイス**:
- [ ] Android 11 (API 30)
- [ ] Android 12 (API 31)
- [ ] Android 13 (API 33)
- [ ] Android 14 (API 34)

**期待結果**:
- [ ] 全てのデバイスで正常に動作

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-COMP-002: iOS デバイスでの動作
**優先度**: 最高
**テスト方法**: 実機テスト

**手順**:
1. 複数のiOSデバイス（異なるOSバージョン）でテスト
2. OCR機能を実行
3. 結果を確認

**テストデバイス**:
- [ ] iOS 15
- [ ] iOS 16
- [ ] iOS 17

**期待結果**:
- [ ] 全てのデバイスで正常に動作

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-COMP-003: Web版での動作
**優先度**: 中
**テスト方法**: ブラウザテスト

**手順**:
1. Web版をビルド: `flutter build web`
2. 複数のブラウザでテスト
3. OCR機能を実行

**テストブラウザ**:
- [ ] Chrome
- [ ] Firefox
- [ ] Safari
- [ ] Edge

**期待結果**:
- [ ] 全てのブラウザで正常に動作

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

### 2.6 回帰テスト

#### TC-REG-001: 既存のリスト機能が正常に動作すること
**優先度**: 高
**テスト方法**: 手動テスト

**手順**:
1. 買い物リストを作成
2. アイテムを追加・削除・編集
3. リストの表示を確認

**期待結果**:
- [ ] 全ての既存機能が正常に動作
- [ ] データが正しく保存される

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-REG-002: 広告表示が正常に動作すること
**優先度**: 高
**テスト方法**: 手動テスト

**手順**:
1. 非プレミアムユーザーでログイン
2. アプリを起動
3. 広告表示を確認

**期待結果**:
- [ ] バナー広告が表示される
- [ ] インタースティシャル広告が適切なタイミングで表示される
- [ ] アプリオープン広告が表示される

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

#### TC-REG-003: 課金機能が正常に動作すること
**優先度**: 最高
**テスト方法**: 手動テスト（サンドボックス環境）

**手順**:
1. テストアカウントでログイン
2. 寄付機能を実行
3. プレミアム機能の有効化を確認

**期待結果**:
- [ ] 課金処理が正常に完了
- [ ] プレミアム機能が有効化される
- [ ] 広告が非表示になる

**実際の結果**:
**状態**: [ ] PASS / [ ] FAIL

---

## 3. テスト環境の準備

### 3.1 ローカル開発環境

#### セットアップ手順
```bash
# 1. functions/.env ファイルを作成
cd functions
cat > .env << EOF
GOOGLE_VISION_API_KEY=AIza...
OPENAI_API_KEY=sk-...
EOF

# 2. Firebase Emulators を起動
firebase emulators:start --only functions

# 3. Flutterアプリをデバッグモードで起動
flutter run --dart-define=USE_FIREBASE_EMULATOR=true
```

#### チェックリスト
- [ ] `functions/.env` が作成されている
- [ ] Firebase Emulators が起動している
- [ ] FlutterアプリがEmulatorに接続している

---

### 3.2 ステージング環境

#### セットアップ手順
```bash
# 1. Firebase Test Projectに切り替え
firebase use test-project

# 2. 環境変数を設定
firebase functions:config:set \
  api.google_vision_key="AIza..." \
  api.openai_key="sk-..."

# 3. Cloud Functions をデプロイ
cd functions
firebase deploy --only functions:analyzeImage

# 4. Flutterアプリをビルド
flutter build apk --debug
```

#### チェックリスト
- [ ] Firebase Test Project が作成されている
- [ ] 環境変数が設定されている
- [ ] Cloud Functions がデプロイされている
- [ ] デバッグビルドが作成されている

---

### 3.3 本番環境

#### セットアップ手順
```bash
# 1. Firebase Production Projectに切り替え
firebase use production

# 2. 環境変数を設定（Firebase Console推奨）
# Firebase Console → Functions → Configuration

# 3. Cloud Functions をデプロイ
cd functions
firebase deploy --only functions:analyzeImage

# 4. Flutterアプリをビルド
flutter build appbundle --release  # Android
flutter build ios --release         # iOS
```

#### チェックリスト
- [ ] Firebase Console で環境変数が設定されている
- [ ] Cloud Functions が本番環境にデプロイされている
- [ ] リリースビルドが作成されている

---

## 4. テスト実施記録

### 4.1 テスト実施サマリー

| カテゴリ | 総テストケース数 | 実施済み | PASS | FAIL | 未実施 |
|---------|----------------|---------|------|------|--------|
| セキュリティ | 5 | 0 | 0 | 0 | 5 |
| 機能 | 6 | 0 | 0 | 0 | 6 |
| パフォーマンス | 3 | 0 | 0 | 0 | 3 |
| エラーハンドリング | 5 | 0 | 0 | 0 | 5 |
| 互換性 | 3 | 0 | 0 | 0 | 3 |
| 回帰 | 3 | 0 | 0 | 0 | 3 |
| **合計** | **25** | **0** | **0** | **0** | **25** |

---

### 4.2 障害管理

#### 発見された障害
| 障害ID | 発見日 | テストケース | 重大度 | 説明 | 状態 | 修正日 |
|--------|--------|-------------|--------|------|------|--------|
| - | - | - | - | - | - | - |

---

### 4.3 テスト完了基準

#### 必須条件
- [ ] 全てのセキュリティテストケース（TC-SEC-001 ~ TC-SEC-005）がPASS
- [ ] 全ての機能テストケース（TC-FUNC-001 ~ TC-FUNC-006）がPASS
- [ ] 重大度"高"のエラーハンドリングテストケースがPASS
- [ ] Android/iOS互換性テストがPASS
- [ ] 既存機能の回帰テストがPASS

#### 推奨条件
- [ ] 全てのパフォーマンステストケースがPASS
- [ ] 全てのエラーハンドリングテストケースがPASS
- [ ] Web版互換性テストがPASS

#### 完了判定
- **PASS条件**: 必須条件が全て満たされ、推奨条件の80%以上が満たされる
- **FAIL条件**: 必須条件のいずれかが満たされない

---

## 5. テスト後の作業

### 5.1 セキュリティ監査

#### 実施項目
1. **静的解析ツールの実行**:
   ```bash
   flutter analyze
   ```

2. **セキュリティスキャン**:
   ```bash
   # APKファイルの文字列抽出
   strings build/app/outputs/flutter-apk/app-release.apk | grep -E "(AIza|sk-)"
   ```

3. **Firebase Security Rules の確認**:
   - Firestore ルールが適切に設定されているか
   - Cloud Functions の認証チェックが有効か

#### チェックリスト
- [ ] 静的解析で警告がゼロ
- [ ] APK/IPAにAPIキーが含まれていない
- [ ] Firebase Security Rulesが適切

---

### 5.2 パフォーマンス監視

#### 設定項目
1. **Firebase Performance Monitoring**:
   - OCR処理時間の追跡
   - ネットワークリクエストの監視

2. **Cloud Functions メトリクス**:
   - 呼び出し回数
   - 実行時間
   - エラー率

3. **アラート設定**:
   - エラー率 > 5%
   - 平均実行時間 > 20秒

#### チェックリスト
- [ ] Firebase Performance Monitoring が有効
- [ ] Cloud Functions のダッシュボードで監視可能
- [ ] アラートが設定されている

---

### 5.3 ドキュメント更新

#### 更新対象
1. **README.md**: 環境変数の設定方法を追記
2. **CLAUDE.md**: デプロイ手順を更新
3. **テスト結果レポート**: 本ドキュメントの完了版を保存

#### チェックリスト
- [ ] README.md が更新されている
- [ ] CLAUDE.md が更新されている
- [ ] テスト結果が記録されている

---

## 6. ロールバック手順

### 6.1 問題発生時の対応

#### 重大な問題が発見された場合
1. **Cloud Functions のロールバック**:
   ```bash
   firebase functions:rollback analyzeImage --version <previous-version>
   ```

2. **アプリのロールバック**:
   - Google Play Console / App Store Connect で以前のバージョンに戻す
   - 段階的ロールアウトを停止

3. **緊急対応**:
   - Firebase Console で Cloud Functions を一時的に無効化
   - アプリ側でOCR機能を無効化するリモート設定を適用

#### チェックリスト
- [ ] ロールバック手順が確認されている
- [ ] 緊急連絡先が明確
- [ ] リモート設定でのフィーチャーフラグが準備されている

---

## 7. テスト完了報告

### 7.1 報告テンプレート

```
# APIキーのサーバー側移行 - テスト完了報告

## テスト実施情報
- **実施者**: [氏名]
- **実施期間**: YYYY-MM-DD ~ YYYY-MM-DD
- **テスト環境**: [ローカル/ステージング/本番]

## テスト結果サマリー
- **総テストケース数**: 25
- **PASS**: XX
- **FAIL**: XX
- **未実施**: XX

## 重大な問題
- [問題の説明]

## 推奨事項
- [推奨される対応]

## 承認
- **テスト責任者**: [氏名] - [日付]
- **プロジェクトマネージャー**: [氏名] - [日付]
```

---

## 8. 参考資料

### 8.1 テストツール
- **Flutter Test**: https://flutter.dev/docs/testing
- **Firebase Emulators**: https://firebase.google.com/docs/emulator-suite
- **APK Analyzer**: Android Studio > Build > Analyze APK

### 8.2 セキュリティベストプラクティス
- **OWASP Mobile Security**: https://owasp.org/www-project-mobile-security/
- **Firebase Security Rules**: https://firebase.google.com/docs/rules

---

## 9. 承認

| 役割 | 氏名 | 日付 | 署名 |
|------|------|------|------|
| テスト責任者 | - | - | - |
| 開発責任者 | - | - | - |
| 承認者 | - | - | - |
