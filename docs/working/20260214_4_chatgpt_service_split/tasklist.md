# タスクリスト - Issue #4: ChatGPTサービスの責務分割

**Issue番号**: #4
**作成日**: 2026-02-14
**ラベル**: refactor, critical

---

## フェーズ1: 準備・設計（2時間）

### T1-1: 現状分析とドキュメント作成 ✅
- [x] `chatgpt_service.dart`の全メソッドを調査
- [x] 依存関係の洗い出し（呼び出し元3ファイル確認）
- [x] requirement.md作成
- [x] tasklist.md作成
- [x] design.md作成
- [x] testing.md作成

**完了条件**: 4つのWorking Documentsが完成していること

---

### T1-2: クラス分割設計の詳細化（1時間）
- [ ] 各クラスの責務を明確化
- [ ] クラス間のインターフェースを定義
- [ ] データフローを図式化
- [ ] 命名規則を確定

**完了条件**:
- クラス図が完成していること
- インターフェース定義が完成していること

**成果物**: `docs/working/20260214_4_chatgpt_service_split/class_diagram.md`

---

### T1-3: テスト戦略の策定（1時間）
- [ ] 単体テストの対象を明確化
- [ ] モック戦略を決定
- [ ] テストデータを準備
- [ ] カバレッジ目標を設定

**完了条件**:
- テスト計画書が完成していること
- テストデータが準備されていること

**成果物**: `test/services/chatgpt/test_plan.md`

---

## フェーズ2: API通信層の分離（4時間）

### T2-1: OpenAIClientクラスの作成（2時間）
- [ ] `lib/services/chatgpt/openai_client.dart`を新規作成
- [ ] API通信の基本機能を実装
  - [ ] POST リクエスト送信
  - [ ] 認証ヘッダー設定
  - [ ] タイムアウト処理
  - [ ] エラーハンドリング
- [ ] リトライロジックを実装
- [ ] レスポンスの型定義を実装

**完了条件**:
- OpenAIClientクラスが動作すること
- 単体テストが通ること

**成果物**:
- `lib/services/chatgpt/openai_client.dart`
- `test/services/chatgpt/openai_client_test.dart`

---

### T2-2: OpenAIClientの単体テスト（1時間）
- [ ] 正常系のテストケース実装
- [ ] 異常系のテストケース実装
  - [ ] 401エラー（認証失敗）
  - [ ] 429エラー（レート制限）
  - [ ] 500エラー（サーバーエラー）
  - [ ] タイムアウト
- [ ] モックHTTPクライアントの実装

**完了条件**: テストカバレッジ90%以上

---

### T2-3: 既存ChatGptServiceへの統合（1時間）
- [ ] ChatGptServiceにOpenAIClientを注入
- [ ] 既存のAPI呼び出しをOpenAIClient経由に変更
- [ ] 動作確認

**完了条件**: 既存のテストが全て通ること

---

## フェーズ3: プロンプト管理の分離（3時間）

### T3-1: PromptTemplateクラスの作成（1.5時間）
- [ ] `lib/services/chatgpt/prompt_template.dart`を新規作成
- [ ] システムプロンプトを外部化
  - [ ] 商品名・価格抽出プロンプト（古い仕様）
  - [ ] 価格候補抽出プロンプト（新仕様）
  - [ ] Vision APIプロンプト
  - [ ] レシピ解析プロンプト（RecipeParserServiceで使用）
- [ ] プロンプトテンプレート機能を実装
- [ ] プロンプトのバージョン管理機能を実装

**完了条件**:
- PromptTemplateクラスが動作すること
- 全プロンプトが外部化されていること

**成果物**:
- `lib/services/chatgpt/prompt_template.dart`
- `lib/services/chatgpt/prompts/` (プロンプト定義ファイル群)

---

### T3-2: PromptTemplateの単体テスト（1時間）
- [ ] テンプレート生成のテストケース実装
- [ ] バージョン管理のテストケース実装

**完了条件**: テストカバレッジ85%以上

---

### T3-3: 既存ChatGptServiceへの統合（0.5時間）
- [ ] ChatGptServiceでPromptTemplateを使用
- [ ] ハードコードされたプロンプトを削除
- [ ] 動作確認

**完了条件**: 既存のテストが全て通ること

---

## フェーズ4: 価格補正ロジックの分離（5時間）

### T4-1: PriceNormalizerクラスの作成（2.5時間）
- [ ] `lib/services/chatgpt/price_normalizer.dart`を新規作成
- [ ] 価格補正機能を実装
  - [ ] 小数点誤認識修正 (`_isLikelyDecimalMisread`)
  - [ ] ハイフン価格修正
  - [ ] ¥記号付き価格修正
  - [ ] 単価文脈判定 (`_isUnitPriceContextNearby`)
  - [ ] 税込ラベル検出 (`_hasTaxLabelNearby`, `_hasTaxLabelInSameLine`)
- [ ] ヘルパーメソッドを実装
  - [ ] `_toIntOrNull`
  - [ ] `_toDoubleOrNull`
- [ ] 価格候補の優先度判定を実装

**完了条件**:
- PriceNormalizerクラスが動作すること
- 既存の価格補正ロジックが全て移植されていること

**成果物**:
- `lib/services/chatgpt/price_normalizer.dart`

---

### T4-2: PriceNormalizerの単体テスト（2時間）
- [ ] 小数点誤認識修正のテストケース
  - [ ] 14904円 → 149円
  - [ ] 18144円 → 181円
  - [ ] 27864円 → 278円
  - [ ] 42984円 → 429円
- [ ] ハイフン価格修正のテストケース
  - [ ] 170-64円 → 170円
  - [ ] 321-84円 → 321円
- [ ] 単価文脈判定のテストケース
  - [ ] 100g当り → true
  - [ ] 円/100g → true
  - [ ] 通常の価格 → false
- [ ] 税込ラベル検出のテストケース
  - [ ] 近傍に「税込」がある → true
  - [ ] 同一行に「税込」がある → true
  - [ ] ラベルがない → false

**完了条件**: テストカバレッジ95%以上

---

### T4-3: 既存ChatGptServiceへの統合（0.5時間）
- [ ] ChatGptServiceでPriceNormalizerを使用
- [ ] 既存の価格補正ロジックを削除
- [ ] 動作確認

**完了条件**: 既存のテストが全て通ること

---

## フェーズ5: レスポンス解析の分離（4時間）

### T5-1: ResponseParserクラスの作成（2時間）
- [ ] `lib/services/chatgpt/response_parser.dart`を新規作成
- [ ] JSON解析機能を実装
  - [ ] ChatGptItemResultの解析
  - [ ] 価格候補リストの解析
  - [ ] エラーハンドリング
- [ ] 信頼度計算機能を実装
- [ ] rawMatchesの解析機能を実装

**完了条件**:
- ResponseParserクラスが動作すること
- 既存の解析ロジックが全て移植されていること

**成果物**:
- `lib/services/chatgpt/response_parser.dart`

---

### T5-2: ResponseParserの単体テスト（1.5時間）
- [ ] 正常系のテストケース実装
  - [ ] 商品名・価格が正しく抽出される
  - [ ] 信頼度が正しく計算される
- [ ] 異常系のテストケース実装
  - [ ] JSON形式が不正
  - [ ] 必須フィールドが欠損
  - [ ] 価格が0円

**完了条件**: テストカバレッジ90%以上

---

### T5-3: 既存ChatGptServiceへの統合（0.5時間）
- [ ] ChatGptServiceでResponseParserを使用
- [ ] 既存のJSON解析ロジックを削除
- [ ] 動作確認

**完了条件**: 既存のテストが全て通ること

---

## フェーズ6: 価格抽出ロジックの分離（4時間）

### T6-1: PriceExtractorクラスの作成（2時間）
- [ ] `lib/services/chatgpt/price_extractor.dart`を新規作成
- [ ] 価格抽出機能を実装
  - [ ] OCRテキストからの価格検出
  - [ ] 税込/税抜判定
  - [ ] 複数価格からの選択ロジック
  - [ ] 小数点価格の検出
  - [ ] 参考税込価格の検出
- [ ] 価格候補の優先度判定を実装

**完了条件**:
- PriceExtractorクラスが動作すること
- 既存の価格抽出ロジックが全て移植されていること

**成果物**:
- `lib/services/chatgpt/price_extractor.dart`

---

### T6-2: PriceExtractorの単体テスト（1.5時間）
- [ ] 税込価格の検出テストケース
  - [ ] 「税込138円」 → 138円（税込）
  - [ ] 「参考税込2838円」 → 2838円（税込）
  - [ ] 小数点価格 → 税込として検出
- [ ] 税抜価格の検出テストケース
  - [ ] 「税抜128円」 → 128円（税抜）
  - [ ] 「本体価格128円」 → 128円（税抜）
- [ ] 複数価格の優先度テストケース
  - [ ] 税込と税抜が混在 → 税込を優先
  - [ ] 高い価格と低い価格 → 高い価格を優先

**完了条件**: テストカバレッジ90%以上

---

### T6-3: 既存ChatGptServiceへの統合（0.5時間）
- [ ] ChatGptServiceでPriceExtractorを使用
- [ ] 既存の価格抽出ロジックを削除
- [ ] 動作確認

**完了条件**: 既存のテストが全て通ること

---

## フェーズ7: ChatGptServiceのリファクタリング（3時間）

### T7-1: ChatGptServiceのスリム化（2時間）
- [ ] 各責務を分離したクラスに委譲
- [ ] 公開APIを維持（後方互換性）
- [ ] 内部実装を整理
- [ ] 不要なコードを削除
- [ ] ドキュメントコメントを追加

**完了条件**:
- ChatGptServiceが500行以内になっていること
- 公開APIが変更されていないこと

---

### T7-2: ChatGptServiceの統合テスト（1時間）
- [ ] 既存の機能が全て動作すること
  - [ ] extractProductInfo（シンプル版）
  - [ ] extractProductInfoFromImage（Vision API版）
  - [ ] extractNameAndPrice（古い仕様）
  - [ ] extractPriceCandidates（新仕様）
- [ ] パフォーマンステスト
  - [ ] API呼び出し時間が10%以上増加していないこと
  - [ ] メモリ使用量が20%以上増加していないこと

**完了条件**:
- 全ての統合テストが通ること
- パフォーマンスが基準を満たしていること

---

## フェーズ8: 依存サービスの更新（2時間）

### T8-1: VisionOcrServiceの更新（0.5時間）
- [ ] `lib/services/vision_ocr_service.dart`を更新
- [ ] ChatGptServiceの新しいAPIを使用
- [ ] 動作確認

**完了条件**: VisionOcrServiceのテストが全て通ること

---

### T8-2: RecipeParserServiceの更新（0.5時間）
- [ ] `lib/services/recipe_parser_service.dart`を更新
- [ ] ChatGptServiceの新しいAPIを使用
- [ ] 動作確認

**完了条件**: RecipeParserServiceのテストが全て通ること

---

### T8-3: HybridOcrServiceの更新（0.5時間）
- [ ] `lib/services/hybrid_ocr_service.dart`を更新
- [ ] ChatGptServiceの新しいAPIを使用
- [ ] 動作確認

**完了条件**: HybridOcrServiceのテストが全て通ること

---

### T8-4: 統合テスト（0.5時間）
- [ ] 全サービスの連携テスト
- [ ] E2Eテスト（カメラ → OCR → ChatGPT → 価格表示）
- [ ] 動作確認

**完了条件**: 全ての統合テストが通ること

---

## フェーズ9: ドキュメント整備とクリーンアップ（2時間）

### T9-1: コードドキュメント整備（1時間）
- [ ] 各クラスにDartDocコメント追加
- [ ] 使用例を追加
- [ ] READMEを更新

**完了条件**:
- dartdocが正常に生成されること
- 全publicメソッドにコメントがあること

---

### T9-2: クリーンアップとコードレビュー準備（1時間）
- [ ] 不要なコメントを削除
- [ ] フォーマット統一（`dart format`）
- [ ] Lint警告の解消（`flutter analyze`）
- [ ] デバッグログの整理
- [ ] TODOコメントの確認

**完了条件**:
- `flutter analyze`で警告が0件
- コードが整理されていること

---

## フェーズ10: レビューとリリース（2時間）

### T10-1: コードレビュー（1時間）
- [ ] 自己レビュー実施
- [ ] チェックリスト確認
  - [ ] 単一責任原則に従っているか
  - [ ] テストカバレッジが基準を満たしているか
  - [ ] パフォーマンスが基準を満たしているか
  - [ ] 後方互換性が保たれているか
- [ ] レビュー依頼

**完了条件**: レビューアーにレビュー依頼を送信

---

### T10-2: 修正とリリース準備（1時間）
- [ ] レビューフィードバックの反映
- [ ] 最終テスト実行
- [ ] CHANGELOG.md更新
- [ ] git commit & push
- [ ] Pull Request作成

**完了条件**:
- Pull Requestが作成されていること
- CIが全て通っていること

---

## 進捗トラッキング

### 進捗サマリー
- **全タスク数**: 33タスク
- **完了タスク数**: 1タスク
- **進捗率**: 3%
- **予想作業時間**: 約31時間

### フェーズ別進捗
| フェーズ | タスク数 | 完了 | 進捗率 | 予想時間 |
|---------|---------|------|--------|----------|
| フェーズ1: 準備・設計 | 3 | 1 | 33% | 4h |
| フェーズ2: API通信層の分離 | 3 | 0 | 0% | 4h |
| フェーズ3: プロンプト管理の分離 | 3 | 0 | 0% | 3h |
| フェーズ4: 価格補正ロジックの分離 | 3 | 0 | 0% | 5h |
| フェーズ5: レスポンス解析の分離 | 3 | 0 | 0% | 4h |
| フェーズ6: 価格抽出ロジックの分離 | 3 | 0 | 0% | 4h |
| フェーズ7: ChatGptServiceのリファクタリング | 2 | 0 | 0% | 3h |
| フェーズ8: 依存サービスの更新 | 4 | 0 | 0% | 2h |
| フェーズ9: ドキュメント整備とクリーンアップ | 2 | 0 | 0% | 2h |
| フェーズ10: レビューとリリース | 2 | 0 | 0% | 2h |
| **合計** | **33** | **1** | **3%** | **31h** |

---

## 注意事項

1. **後方互換性**: 必ず既存の公開APIを維持すること
2. **テスト**: 各フェーズでテストを必ず実行すること
3. **段階的リリース**: 可能であればFeature Flagを使用して段階的にリリース
4. **ロールバック計画**: 問題が発生した場合のロールバック手順を準備
5. **依存関係**: フェーズの順序を守り、依存関係を考慮すること

---

## リスク管理

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| API仕様の理解不足 | 高 | 中 | OpenAI公式ドキュメントの確認、既存コードの動作確認 |
| テスト不足 | 高 | 中 | テストカバレッジ目標の設定、レビュー時の重点確認 |
| パフォーマンス低下 | 中 | 低 | パフォーマンステストの実施、ベンチマーク比較 |
| 既存機能の破壊 | 高 | 低 | 統合テストの充実、段階的リリース |
| 作業時間超過 | 中 | 中 | タスク分割の細分化、優先度の明確化 |
