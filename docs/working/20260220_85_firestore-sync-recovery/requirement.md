# 要件定義

**Issue**: #85
**作成日**: 2026-02-20
**ラベル**: bug

## ユーザーストーリー

ユーザー「買い物リストを更新したのに、別のデバイスに反映されない。ログアウトして入り直せば直るけど、いちいちそれをするのは面倒だし不安になる。」
アプリ「クラウド同期が途切れた場合、自動的に再接続し、ユーザーが意識することなくデータを最新に保つ。」

## 要件一覧

### 必須要件

- [ ] TTLキャッシュチェック（5分）でloadData()が早期リターンしても、リアルタイム購読が確立されていなければ再開する
- [ ] Firestoreリアルタイム購読のonErrorで指数バックオフ付き自動再購読を実装する
- [ ] 認証状態変更時（ログイン/ログアウト）にリアルタイム同期の開始・停止を確実に行う
- [ ] リアルタイム購読のアクティブ状態を追跡し、購読が切れたことを検知できるようにする
- [ ] ローカルモードフラグの状態管理を整理し、矛盾が生じないようにする

### オプション要件

- [ ] アプリフォアグラウンド復帰時に同期状態をチェックし、必要に応じて再購読する
- [ ] 同期状態をUIに表示し、ユーザーに現在の状態を伝える（例: 同期アイコン）
- [ ] 同期断絶時に手動再同期ボタンを提供する

## 受け入れ基準

- [ ] ログアウト→5分以内にログインしても、リアルタイム同期が正常に開始される
- [ ] ネットワーク切断→復帰後、自動的にリアルタイム同期が再開される
- [ ] loadData()が複数回呼ばれても、リアルタイム購読の状態が正しく維持される
- [ ] 既存のバッチ更新・楽観的更新のロジックに悪影響を与えない
- [ ] flutter test が全パスする
- [ ] flutter analyze でエラーがない
