# 要件定義書：バーコードスキャン機能統合

## 1. プロジェクト概要

### 1.1 プロジェクト名
まいカゴ - バーコードスキャン機能統合プロジェクト

### 1.2 目的
既存の値札撮影機能に加えて、ML KitのバーコードスキャンAPIとYahoo!ショッピングAPIを組み合わせた商品バーコードスキャン機能を統合し、ユーザーが値札撮影とバーコードスキャンを任意で切り替えられるようにする。

### 1.3 背景
- 現在のアプリは値札撮影によるOCR機能のみを提供
- ユーザーからバーコードスキャン機能の要望
- 商品の価格は店舗によって異なるため、価格はあくまで参考価格として表示し、リストには設定しない。

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 統合カメラ画面
- **機能名**: 拡張カメラ画面
- **概要**: 値札撮影とバーコードスキャンを切り替え可能な統合画面
- **詳細**:
  - 既存の「カメラで追加」ボタンから起動
  - 値札撮影モードとバーコードスキャンモードを切り替え可能
  - モード切り替えは画面上部のトグルボタンで実行
  - 各モードに応じた適切なUI表示

#### 2.1.2 値札撮影機能（既存機能の維持）
- **機能名**: 値札撮影モード
- **概要**: 既存のOCR機能による値札読み取り
- **詳細**:
  - 既存のカメラ機能をそのまま維持
  - ズーム機能、撮影ガイドライン表示
  - OCR処理による商品名・価格の自動抽出

#### 2.1.3 バーコードスキャン機能（新規追加）
- **機能名**: バーコードスキャンモード
- **概要**: ML Kitを使用したバーコード読み取りとYahoo!ショッピングAPIによる商品情報取得
- **詳細**:
  - 対応バーコード形式: EAN-13, EAN-8, UPC-A, UPC-E
  - リアルタイムバーコード検出
  - スキャンエリアのガイド表示
  - 自動商品情報取得

### 2.2 商品情報取得機能

#### 2.2.1 Yahoo!ショッピングAPI連携
- **機能名**: 商品情報取得サービス
- **概要**: バーコードから商品情報を取得
- **詳細**:
  - JANコードをYahoo!ショッピングAPIに送信
  - 商品名、価格情報の取得
  - 参考価格であることを明示
  - エラーハンドリング（商品が見つからない場合など）

#### 2.2.2 商品情報モデル
- **機能名**: 商品情報データ構造
- **概要**: 取得した商品情報を管理するデータ構造
- **詳細**:
  - 商品名（String）
  - 価格（int）
  - JANコード（String）
  - 参考価格フラグ（bool）
  - 最終更新日時（DateTime）

### 2.3 ユーザーインターフェース

#### 2.3.1 モード切り替えUI
- **機能名**: モード切り替えトグル
- **概要**: 値札撮影とバーコードスキャンの切り替え
- **詳細**:
  - 画面上部にトグルボタンを配置
  - 視覚的に分かりやすいアイコンとラベル
  - 現在のモードを明確に表示

#### 2.3.2 各モード専用UI
- **値札撮影モード**:
  - 既存のカメラUIを維持
  - ズームコントロール
  - 撮影ボタン
- **バーコードスキャンモード**:
  - スキャンエリアのガイド枠
  - バーコード検出時のフィードバック
  - 商品情報取得中のローディング表示

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **レスポンス時間**: バーコードスキャンから商品情報表示まで3秒以内
- **API呼び出し**: Yahoo!ショッピングAPIの呼び出し制限内での運用
- **メモリ使用量**: 既存機能に影響を与えない範囲での実装

### 3.2 可用性要件
- **ネットワークエラー**: オフライン時の適切なエラーメッセージ表示
- **API制限**: Yahoo!ショッピングAPIの制限に達した場合の処理
- **商品未発見**: 商品情報が見つからない場合の適切なフィードバック

### 3.3 互換性要件
- **既存機能**: 既存の値札撮影機能に影響を与えない
- **データ構造**: 既存のItemモデルとの互換性を維持
- **UI/UX**: 既存のデザインシステムに準拠

## 4. 技術要件

### 4.1 使用技術
- **ML Kit**: バーコードスキャン機能
- **Yahoo!ショッピングAPI**: 商品情報取得
- **mobile_scanner**: バーコードスキャンライブラリ
- **http**: API通信
- **既存のOCR機能**: 値札撮影機能

### 4.2 アーキテクチャ要件
- **モジュール化**: 新機能は独立したサービスとして実装
- **エラーハンドリング**: 適切な例外処理とユーザーフィードバック
- **リソース管理**: カメラリソースの適切な管理

## 5. 制約事項

### 5.1 技術的制約
- **API制限**: Yahoo!ショッピングAPIの利用制限
- **価格情報**: 取得した価格は参考価格として扱う
- **商品データ**: 全ての商品がYahoo!ショッピングで見つかるとは限らない

### 5.2 ビジネス制約
- **既存機能の維持**: 現在のユーザーに影響を与えない
- **開発期間**: 既存の開発スケジュールに影響を与えない範囲
- **コスト**: API利用料金の考慮

## 6. 受け入れ基準

### 6.1 機能テスト
- [ ] 値札撮影モードが正常に動作する
- [ ] バーコードスキャンモードが正常に動作する
- [ ] モード切り替えがスムーズに実行される
- [ ] 商品情報が正常に取得・表示される
- [ ] エラー時の適切なメッセージ表示

### 6.2 非機能テスト
- [ ] レスポンス時間が要件を満たす
- [ ] メモリ使用量が許容範囲内
- [ ] ネットワークエラー時の適切な処理
- [ ] 既存機能への影響がない

### 6.3 ユーザビリティテスト
- [ ] 直感的なモード切り替え操作
- [ ] 分かりやすいUI表示
- [ ] 適切なフィードバック表示

## 7. リスクと対策

### 7.1 技術リスク
- **API制限**: Yahoo!ショッピングAPIの制限に達する可能性
  - 対策: 適切なキャッシュ機能の実装
- **商品情報の不正確性**: 価格情報が実際と異なる可能性
  - 対策: 参考価格であることを明示

### 7.2 ビジネスリスク
- **既存ユーザーへの影響**: 新機能追加による既存機能への影響
  - 対策: 既存機能の完全な維持とテスト

## 8. 実装計画

### 8.1 開発フェーズ
1. **Phase 1**: Yahoo!ショッピングAPIサービスの実装
2. **Phase 2**: 統合カメラ画面の実装
3. **Phase 3**: バーコードスキャン機能の統合
4. **Phase 4**: テストとデバッグ
5. **Phase 5**: リリース準備

### 8.2 マイルストーン
- **M1**: APIサービス完成
- **M2**: 統合UI完成
- **M3**: 機能統合完成
- **M4**: テスト完了
- **M5**: リリース

## 9. 付録

### 9.1 用語集
- **ML Kit**: Googleが提供する機械学習ライブラリ
- **JANコード**: 日本の商品識別コード
- **OCR**: 光学文字認識技術
- **API**: アプリケーションプログラミングインターフェース

### 9.2 参考資料
- ML Kit公式ドキュメント
- Yahoo!ショッピングAPI仕様書
- 既存アプリの技術仕様書

---

## 10. 実装詳細

### 10.1 ファイル構成
```
lib/
├── services/
│   └── yahoo_shopping_service.dart    # Yahoo!ショッピングAPIサービス
├── screens/
│   └── enhanced_camera_screen.dart    # 統合カメラ画面
└── models/
    └── product_info.dart              # 商品情報モデル
```

### 10.2 主要な実装ポイント

#### 10.2.1 Yahoo!ショッピングAPIサービス
```dart
class YahooShoppingService {
  static const String _baseUrl = 'https://shopping.yahooapis.jp/ShoppingWebService/V3/itemSearch';
  final String _appId;

  Future<ProductInfo?> getProductByJanCode(String janCode) async {
    // JANコードから商品情報を取得
  }
}
```

#### 10.2.2 統合カメラ画面
```dart
class EnhancedCameraScreen extends StatefulWidget {
  final Function(File image)? onImageCaptured;
  final Function(ProductInfo product)? onProductDetected;
  
  // 値札撮影とバーコードスキャンの切り替え機能
}
```

#### 10.2.3 商品情報モデル
```dart
class ProductInfo {
  final String name;
  final int price;
  final String janCode;
  final bool isReferencePrice;
  final DateTime lastUpdated;
}
```

### 10.3 設定要件

#### 10.3.1 Yahoo!デベロッパーネットワーク
- Yahoo!デベロッパーネットワークでのアプリ登録が必要
- アプリケーションIDの取得
- API利用制限の確認

#### 10.3.2 権限設定
- カメラ権限（既存）
- ネットワーク権限（既存）

### 10.4 テスト要件

#### 10.4.1 単体テスト
- Yahoo!ショッピングAPIサービスのテスト
- 商品情報モデルのテスト
- エラーハンドリングのテスト

#### 10.4.2 統合テスト
- バーコードスキャンから商品情報取得までの一連の流れ
- モード切り替えの動作確認
- 既存機能への影響確認

#### 10.4.3 UIテスト
- モード切り替えの操作性
- エラー時の表示確認
- ローディング表示の確認

---

**作成日**: 2024年12月19日  
**バージョン**: 1.0  
**作成者**: AI Assistant  
**承認者**: [承認者名]
