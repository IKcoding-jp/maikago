# Deploy Flutter web app to Firebase Hosting on merge to main
name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main

permissions:
  contents: read
  checks: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - run: flutter pub get
      # env.jsonはpubspec.yamlのアセットに必要（空のプレースホルダー）
      # 実際の値は--dart-defineで注入するため、本番ビルドには秘密情報を含まない
      - run: echo '{}' > env.json
      - run: |
          flutter build web \
            --dart-define=FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }} \
            --dart-define=FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }} \
            --dart-define=FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }} \
            --dart-define=FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }} \
            --dart-define=FIREBASE_MEASUREMENT_ID=${{ secrets.FIREBASE_MEASUREMENT_ID }} \
            --dart-define=GOOGLE_WEB_CLIENT_ID=${{ secrets.GOOGLE_WEB_CLIENT_ID }} \
            --dart-define=ADMOB_INTERSTITIAL_AD_UNIT_ID=${{ secrets.ADMOB_INTERSTITIAL_AD_UNIT_ID }} \
            --dart-define=ADMOB_BANNER_AD_UNIT_ID=${{ secrets.ADMOB_BANNER_AD_UNIT_ID }} \
            --dart-define=ADMOB_APP_OPEN_AD_UNIT_ID=${{ secrets.ADMOB_APP_OPEN_AD_UNIT_ID }}
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAIKAGO2 }}
          channelId: live
          projectId: maikago2
