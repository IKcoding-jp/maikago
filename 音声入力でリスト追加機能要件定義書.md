# 音声入力でリスト追加機能 要件定義書

## 1. 概要
スマートフォンの音声入力を利用して、ユーザーがアプリ内のリスト（買い物リスト等）に項目を追加できる機能を提供する。

## 2. 目的
- 操作の効率化：手入力の手間を減らすことで素早く項目を追加できるようにする。
- アクセシビリティ向上：視覚・操作に制約のあるユーザーでも使いやすくする。

## 3. スコープ
- 音声認識による単一項目の追加（例：「りんごを追加」→「りんご」）
- 複数項目の一括追加（句点や「と」で区切った場合の解析）
- 音声入力の開始／停止、確認ダイアログ、認識結果の編集
- ローカルおよびOSレベルの音声認識を利用。ネットワーク認識はオプション（設定で切替可）

### 3.1 項目の属性対応
- 既存アプリの仕様に合わせ、各リスト項目は以下の属性を音声で指定できる。指定がなければ未入力（null/空）で保存可能とする。
  - リスト名（例: りんご）
  - 個数（例: 2、2個、二つ）
  - 単価（例: 100円、100）
  - 割引率（例: 5%、5パーセント）

音声でこれらを同時に指定できる（例: 「りんご、個数2、単価100円、割引5パーセントを追加」）。

## 4. 利用者シナリオ
1. ホーム画面でマイクアイコンをタップ → 「牛乳と卵を追加」と話す → 認識結果を確認 → 保存
2. ハンズフリーで複数項目を連続追加
3. 誤認識時にテキストを編集して保存
4. ホーム画面で音声入力ボタンをオンにすると、常時音声入力が可能になり、話しかけるだけで自動的にリストに追加される
5. 音声入力ボタンをオフにすると、通常の手動入力モードに戻る

## 5. 機能要件
- **REQ-F1**: マイクボタンで音声入力を開始・停止できること。
- **REQ-F2**: 音声をテキスト化して候補を表示すること（即時プレビュー）。
- **REQ-F3**: 複数項目を認識して個別のリストアイテムに分割できること（区切り語: 「と」「、」「および」など）。
- **REQ-F4**: 認識結果をユーザーが編集、削除できること（確認ダイアログ）。
- **REQ-F5**: 認識中／処理中は適切なUIフィードバック（波形、インジケーター）を表示すること。
- **REQ-F6**: オフライン環境での動作（OS提供のオフライン音声認識が可能な場合）をサポートすること。
- **REQ-F7**: 設定で自動追加（認識後即保存）と手動確認モードを切替可能にすること。
- **REQ-F8**: 音声から個数・単価・割引率を抽出して対応するフィールドに格納できること。未指定フィールドは空のまま保存する。
- **REQ-F9**: ホーム画面に音声入力のオン/オフ切り替えボタンを配置すること。
- **REQ-F10**: 音声入力がオンの状態では、バックグラウンドで常時音声を監視し、認識された内容を自動的にリストに追加すること。
- **REQ-F11**: 音声入力中は視覚的なフィードバック（マイクアイコンの色変更、アニメーション）を表示すること。
- **REQ-F12**: 音声入力の開始/停止を音声コマンドでも制御できること（例：「音声入力を開始」「音声入力を停止」）。

## 6. 非機能要件
- **NFR-1**: 音声認識の初期応答は1秒以内を目標とする（UI応答）。
- **NFR-2**: 認識精度は主要語彙で80%以上を目標とする（評価項目はテストケース参照）。
- **NFR-3**: プライバシー遵守：音声データはユーザーの明示同意がない限り保存しない。
- **NFR-4**: アクセシビリティを考慮し、スクリーンリーダーで操作可能であること。

## 7. UI/UX要件
- マイクアイコンを明確に配置（`+`ボタン近辺またはツールバー）。
- 認識結果はテキストバブルで表示し、項目ごとに分割された編集可能なChip/Listで提示。
- 認識中はアニメーション（波形）を表示、停止／キャンセルボタンを明示。
- 設定画面に音声入力のオン／オフ、即時追加モード、言語選択を追加。
- ホーム画面の右上またはツールバーに音声入力のオン/オフ切り替えボタンを配置する。
+- 音声入力がオンの状態では、マイクアイコンが点灯またはアニメーション表示される。
+- 音声入力中は画面下部に小さな通知バーで「音声入力中...」と表示する。
+- 音声コマンドで制御する場合は、開始/停止のキーワードを設定画面でカスタマイズ可能にする。

## 8. エッジケースと振る舞い
- 背景ノイズで認識が不安定な場合は「再試行」ボタンを表示。
- 何も認識できなかった場合はユーザーに通知し、手動入力へフォールバックする。
- 長文・命令文（例：「牛乳と卵を買ってきて」）は要素抽出して名詞を優先的に追加する。
- 音声で数値や単位が曖昧な場合（例：「二つ」「ニ個」「2こ」）は正規化して保存する。単価の通貨単位が不明な場合はアプリのデフォルト通貨を用いる。
- 割引率はパーセント表現を優先的に解釈し、百分率として保存する（例: 「5%」「5パーセント」→ 5）。
- 同一文で複数属性が与えられた場合、項目単位で紐付ける。誤解が起きやすい場合は確認ダイアログでユーザーに提示する。
+- 常時音声入力中に誤認識が発生した場合、短時間（3秒以内）で「取り消し」と話すことで最後に追加した項目を削除できる。
+- 音声入力のオン/オフ状態はアプリの設定に保存し、次回起動時も維持される。
+- バックグラウンド音声監視中は、システムの音声認識権限が継続的に必要となるため、権限の確認と更新を適切に処理する。

### 属性パースの優先ルール（簡潔）
- 文中に数値（%や円などの単位を伴う）が見つかった場合、それを直前の名詞（商品名）に紐付ける。複数名詞が存在する場合は句読点や助詞（「は」「を」「と」）で分割して対応。
- 明示的な単位（円、円分、パーセント、％）がない数値は文脈（個数の語尾「個」「本」「枚」等）から推定する。

## 9. テストケース（受け入れ基準）
- TC-1: 「りんご」と話し、1件のアイテムが追加される。
- TC-2: 「牛乳と卵」と話し、2件（牛乳、卵）が追加される。
- TC-3: 誤認識時にテキスト編集で修正でき、修正後に保存される。
- TC-4: オフライン環境で認識が失敗した際、適切なフォールバックが動作する。
- TC-5: 設定で自動追加をオンにした場合、認識後自動で保存される。
- TC-6: 「りんご、個数2、単価100円、割引5パーセント」と話し、1件が追加され、属性（個数=2、単価=100、割引率=5）が正しく保存される。
- TC-7: 「牛乳2本100円」と話し、牛乳（個数=2、単価=100）が追加される。
- TC-8: 属性指定がない場合（例: 「バナナを追加」）は項目名のみが保存され、個数・単価・割引率は空である。
+- TC-9: ホーム画面で音声入力ボタンをオンにすると、マイクアイコンが点灯し、常時音声入力が可能になる。
+- TC-10: 常時音声入力中に「りんごを追加」と話すと、自動的にリストに追加される。
+- TC-11: 音声入力ボタンをオフにすると、マイクアイコンが消灯し、音声入力が停止する。
+- TC-12: 「音声入力を開始」「音声入力を停止」の音声コマンドで制御できる。
+- TC-13: 誤認識で追加した項目を「取り消し」の音声コマンドで削除できる。
+- TC-14: 音声入力のオン/オフ状態がアプリ再起動後も維持される。

## 10. プライバシー／セキュリティ
- 音声データはデフォルトで送信・保存しない。クラウド音声認識を利用する場合は明示同意を取得する。
- 同意は設定画面／初回利用時に表示するポップアップで取得。

## 11. ローカライズ／言語サポート
- 初期は日本語をサポート。将来的に英語などを追加できるように設計する。
- 言語選択は設定で変更可能とする。

## 12. アクセシビリティ
- VoiceOver / TalkBack で操作できるラベル付けを行う。
- マイク開始・停止・キャンセルはキーボードフォーカスでも操作可能にする。

## 13. 依存関係／実装メモ
- Flutterの`speech_to_text`等のパッケージを検討。iOS/AndroidのネイティブAPIにフォールバック可能にする。
- 句読点・助詞解析は簡易的な形態素解析（MeCabラッパー等）または正規表現ベースで実装可能。
- プライバシー方針の更新が必要。
+- 常時音声入力には`speech_to_text`パッケージの`listenFor`メソッドを継続的に呼び出す必要がある。
+- バックグラウンド音声監視の権限管理には`permission_handler`パッケージが必要。
+- 音声入力状態の永続化には既存の`SharedPreferences`を使用。
+- 音声コマンドの認識には、特定のキーワード（「開始」「停止」「取り消し」）を優先的に検出する仕組みが必要。

## 14. ロールアウト計画
- v1: 単一項目・確認モードの実装（デフォルトオフ）
- v2: 複数項目分割、即時追加モード、設定追加
- v3: クラウド認識、言語追加、改善
+- v4: 常時音声入力機能、音声コマンド制御、取り消し機能
+- v5: 高度な音声認識精度向上、カスタマイズ機能拡張

## 15. 受け入れ基準（簡潔）
- 主要シナリオ（TC-1〜TC-3）が自動テストおよび手動テストでパスすること。
+- 常時音声入力機能（TC-9〜TC-14）が正常に動作すること。
+- 音声入力のオン/オフ状態が適切に保存・復元されること。

+## 16. 実装優先度
+- **高**: 基本的な音声入力機能（REQ-F1〜F8）
+- **中**: 常時音声入力機能（REQ-F9〜F12）
+- **低**: 音声コマンド制御、取り消し機能

+## 17. 技術的考慮事項
+- 常時音声入力はバッテリー消費が大きいため、省電力モードの実装を検討する。
+- プライバシー保護のため、音声データの保存・送信は最小限に抑える。
+- 音声認識の精度向上のため、ユーザーの音声パターンを学習する機能を将来的に検討する。

---
作成日: 2025-08-17


